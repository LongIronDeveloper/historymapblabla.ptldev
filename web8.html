<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒê·ªì Chi·∫øn Thu·∫≠t - Tactical Editor v6 (Update Delete Mode)</title>
    
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Styling */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Roboto', sans-serif; }
        
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #e0d5b0; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 360px;
            height: 100vh;
            background: #2b2b2b;
            color: #dcdcdc;
            padding: 15px;
            box-sizing: border-box;
            transition: transform 0.3s ease;
            position: absolute;
            z-index: 1000;
            left: 0; top: 0;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.6);
            border-right: 3px solid #8b4513;
            display: flex; flex-direction: column; gap: 12px;
        }
        #sidebar.collapsed { transform: translateX(-370px); }

        /* Headers */
        h2 { 
            margin: 0; font-family: 'Cinzel', serif; font-size: 22px; 
            text-align: center; color: #f39c12; 
            border-bottom: 2px solid #8b4513; padding-bottom: 10px; 
            text-shadow: 1px 1px 2px black; letter-spacing: 1px;
        }
        h3 { margin: 0; border-bottom: 1px solid #555; padding-bottom: 5px; font-size: 14px; color: #f1c40f; text-transform: uppercase; letter-spacing: 1px; }

        /* Controls */
        .control-group { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; border: 1px solid #444; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; }
        
        input, select, button { width: 100%; margin-bottom: 8px; padding: 8px; border-radius: 4px; border: 1px solid #555; background: #3c3c3c; color: white; font-size: 13px; }
        input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle; }
        
        button.btn-action { background: #5d4037; font-weight: bold; border: 1px solid #8d6e63; cursor: pointer; color: #f1c40f; }
        button.btn-action:hover { background: #795548; }

        /* Icon Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .icon-option { background: #4a3b32; border: 1px solid #6d4c41; padding: 8px; text-align: center; cursor: pointer; border-radius: 4px; }
        .icon-option.selected { background: #f1c40f; color: #2c3e50; border-color: #fff; box-shadow: 0 0 8px #f1c40f; }
        
        /* Help Box */
        .help-box { font-size: 12px; color: #bdc3c7; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; line-height: 1.5; border-left: 3px solid #e74c3c; }
        .help-key { display: inline-block; background: #eee; color: #333; padding: 0 4px; border-radius: 2px; font-weight: bold; font-family: monospace; font-size: 10px; }

        /* Toggle Buttons */
        #toggle-btn, #label-toggle-btn {
            position: absolute; width: 36px; height: 36px; z-index: 2000;
            background: #8b4513; color: white; border: 2px solid #d35400; cursor: pointer; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        #toggle-btn { top: 15px; right: 15px; } 
        #label-toggle-btn { top: 15px; right: 60px; background: #2c3e50; border-color: #34495e; }
        
        /* Timeline Table */
        .timeline-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .timeline-table td { padding: 4px; border-bottom: 1px solid #444; vertical-align: middle; }
        .order-input { width: 40px; text-align: center; background: #222; border: 1px solid #555; color: #f1c40f; font-weight: bold; padding: 2px; margin: 0; }
        .order-input:focus { border-color: #f1c40f; outline: none; }

        /* Floating Legend */
        #floating-legend {
            position: absolute; bottom: 20px; right: 20px;
            width: 300px; max-height: 50vh;
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #8b4513; border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 2000;
            overflow: hidden; 
            color: #333; font-family: 'Merriweather', serif;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: bottom right;
        }
        #floating-legend.minimized { transform: translateY(calc(100% - 36px)); }
        
        .legend-header {
            background: #8b4513; color: #f1c40f; padding: 10px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            font-size: 13px; text-transform: uppercase; user-select: none;
        }
        .legend-body { padding: 5px; overflow-y: auto; max-height: calc(50vh - 40px); }
        .legend-row { display: flex; align-items: center; gap: 10px; padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .legend-row:hover { background: #f0e6d2; }
        .l-icon { width: 30px; text-align: center; display: flex; justify-content: center; align-items: center; }
        .l-text { flex: 1; font-size: 12px; line-height: 1.3; }
        
        /* Map Feature Styles */
        .map-feature i { filter: sepia(0.4) drop-shadow(0px 2px 2px rgba(0,0,0,0.8)); }
        .custom-text-marker { text-shadow: 1px 1px 0 #000; }
        .bend-popup { font-size: 11px; color: #333; }

        /* --- NEW STYLES FOR DELETE MODE --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 320px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-family: Arial, sans-serif;
        }
        .modal-content h3 { color: #d9534f; margin-top: 0; border-bottom: none; font-size: 18px; text-align: left; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-danger { background: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: auto; }
        .btn-secondary { background: #ccc; color: black; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: auto; }
        
        /* Hi·ªáu ·ª©ng ch·ªçn ƒë·ªÉ x√≥a */
        .selected-danger {
            outline: 3px dashed red !important;
            border-radius: 4px;
            box-shadow: 0 0 10px red;
            background: rgba(255, 0, 0, 0.2);
        }

    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleSidebar()" title="ƒê√≥ng/M·ªü B·∫£ng C√¥ng C·ª•"><i class="fas fa-bars"></i></button>
    <button id="label-toggle-btn" onclick="toggleMapLabels()" title="·∫®n/Hi·ªán T√™n ƒê·ªãa Danh"><i class="fas fa-font"></i></button>

    <div id="sidebar">
        <h2>B·∫¢NG C√îNG C·ª§ V·∫º</h2>

        <div class="control-group">
            <h3><i class="fas fa-info-circle"></i> H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</h3>
            <div class="help-box">
                <b>1. M≈©i T√™n/V√πng:</b> Click t·∫°o ƒëi·ªÉm, click ƒë√∫p k·∫øt th√∫c. Gi·ªØ <span class="help-key">Z</span> di chu·ªôt ƒë·ªÉ b·∫ª cong.<br>
                <b>2. Xoay M≈©i T√™n:</b> Click ƒë·∫ßu m≈©i t√™n -> Nh·∫•n <span class="help-key">A</span>/<span class="help-key">D</span>.<br>
                <b>3. Timeline:</b> N√∫t T/Y ch·ªânh b∆∞·ªõc. N√∫t "M·∫Øt" hi·ªán t·∫•t c·∫£.<br>
                <b style="color:#e74c3c;">4. X√≥a ƒë·ªëi t∆∞·ª£ng:</b> Ch·ªçn "Ch·∫ø ƒë·ªô X√≥a", click v√†o ƒë·ªëi t∆∞·ª£ng (hi·ªán vi·ªÅn ƒë·ªè), sau ƒë√≥ nh·∫•n ph√≠m <span class="help-key">X</span>.
            </div>
        </div>

        <div class="control-group">
            <h3>C√¥ng C·ª• Chi·∫øn Thu·∫≠t</h3>
            <select id="draw-mode" onchange="updateUI()">
                <option value="none">-- Ch·ªçn Ch·∫ø ƒê·ªô --</option>
                <option value="arrow">M≈©i T√™n (Chi·∫øn d·ªãch)</option>
                <option value="marker">Bi·ªÉu T∆∞·ª£ng (Icon)</option>
                <option value="text">VƒÉn B·∫£n (Ghi ch√∫)</option>
                <option value="polygon">V√πng Ho·∫°t ƒê·ªông</option>
                <option value="delete" style="color: #e74c3c; font-weight: bold;">üóëÔ∏è Ch·∫ø ƒë·ªô X√≥a</option>
            </select>
            <button class="btn-action" id="action-btn" onclick="toggleDrawing()">B·∫Øt ƒë·∫ßu v·∫Ω</button>
        </div>

        <div id="options-panel">
            <div class="control-group">
                <label>Thu·ªôc t√≠nh chung:</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="color" id="draw-color" value="#c0392b" style="width:40px; height:30px; padding:0;">
                    <input type="number" id="draw-size" value="4" min="1" max="20" title="K√≠ch th∆∞·ªõc" style="width:50px;">
                </div>
                
                <div id="arrow-specific-options" style="display:none; margin-top:5px;">
                     <label><input type="checkbox" id="draw-dashed"> N√©t ƒë·ª©t (R√∫t lui/B√≠ m·∫≠t)</label>
                </div>

                <div id="polygon-specific-options" style="display:none; margin-top:5px;">
                    <label><input type="checkbox" id="poly-smooth" checked> L√†m m·ªÅm (Bo tr√≤n)</label>
                    <label><input type="checkbox" id="poly-dashed"> Vi·ªÅn n√©t ƒë·ª©t</label>
                </div>

                <input type="text" id="draw-label" placeholder="T√™n (Hi·ªÉn th·ªã trong timeline)..." style="margin-top:5px;">
            </div>

            <div class="control-group" id="icon-options" style="display:none;">
                <label>Bi·ªÉu t∆∞·ª£ng:</label>
                <div class="icon-grid">
                    <div class="icon-option selected" onclick="selectIcon('fire')" title="N∆°i kh·ªüi nghƒ©a"><i class="fas fa-fire" style="color:#e67e22"></i></div>
                    <div class="icon-option" onclick="selectIcon('flag')" title="S·ªü ch·ªâ huy"><i class="fas fa-flag" style="color:#c0392b"></i></div>
                    <div class="icon-option" onclick="selectIcon('star')" title="Chi·∫øn th·∫Øng"><i class="fas fa-star" style="color:#f1c40f"></i></div>
                    <div class="icon-option" onclick="selectIcon('chess-rook')" title="Th√†nh tr√¨"><i class="fas fa-chess-rook" style="color:#7f8c8d"></i></div>
                    <div class="icon-option" onclick="selectIcon('skull')" title="Ti√™u di·ªát"><i class="fas fa-skull" style="color:#fff"></i></div>
                    <div class="icon-option" onclick="selectIcon('campground')" title="Doanh tr·∫°i"><i class="fas fa-campground" style="color:#27ae60"></i></div>
                </div>
            </div>

            <div class="control-group" id="text-options" style="display:none;">
                <input type="text" id="text-content" placeholder="N·ªôi dung ch·ªØ...">
                <select id="text-font">
                    <option value="'Merriweather', serif">Merriweather (C·ªï ƒëi·ªÉn)</option>
                    <option value="'Roboto', sans-serif">Roboto (Hi·ªán ƒë·∫°i)</option>
                </select>
                <div style="display:flex; gap:10px;">
                    <label><input type="checkbox" id="text-bold" checked> ƒê·∫≠m</label>
                    <label><input type="checkbox" id="text-italic"> Nghi√™ng</label>
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>Di·ªÖn Bi·∫øn (M≈©i T√™n)</h3>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span id="current-step-display" style="font-size:13px; font-weight:bold; color:#f1c40f;">Hi·ªán t·∫•t c·∫£</span>
                <div style="display:flex; gap: 2px;">
                    <button onclick="changeTimeline(-1)" style="width:30px; margin:0;" title="L√πi (Y)">Y</button>
                    <button onclick="changeTimeline(1)" style="width:30px; margin:0;" title="Ti·∫øn (T)">T</button>
                    <button onclick="showAllTimeline()" style="width:30px; margin:0; background:#f39c12; color:#000;" title="Hi·ªán t·∫•t c·∫£ (M·∫Øt)"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2);">
                <table class="timeline-table">
                    <thead>
                        <tr style="color:#aaa; border-bottom:1px solid #555;">
                            <th align="center">STT</th>
                            <th align="left">T√™n ƒê∆°n V·ªã</th>
                            <th>X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="timeline-list"></tbody>
                </table>
            </div>
        </div>
        
        <div class="control-group" style="margin-top:auto;">
             <button class="btn-action" onclick="exportJSON()">L∆∞u B·∫£n ƒê·ªì (JSON)</button>
             <input type="file" id="file-input" style="display: none;" onchange="importJSON(this)">
             <button class="btn-action" style="background:#333; margin-top:5px;" onclick="document.getElementById('file-input').click()">M·ªü B·∫£n ƒê·ªì</button>
        </div>
    </div>

    <div id="floating-legend">
        <div class="legend-header" onclick="toggleLegend()">
            <span><i class="fas fa-map"></i> Ch√∫ Gi·∫£i</span>
            <i class="fas fa-chevron-down" id="legend-icon"></i>
        </div>
        <div class="legend-body" id="static-legend-container"></div>
    </div>

    <div id="map"></div>

    <div id="delete-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
            <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªëi t∆∞·ª£ng ƒëang ch·ªçn kh√¥ng?</p>
            
            <label style="display:block; margin: 10px 0; font-size: 13px; color:#555;">
                <input type="checkbox" id="chk-no-remind"> Kh√¥ng nh·∫Øc l·∫°i c·∫£nh b√°o n√†y
            </label>
            
            <div class="modal-buttons">
                <button id="btn-confirm-delete" class="btn-danger">X√≥a</button>
                <button id="btn-cancel-delete" class="btn-secondary">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH B·∫¢N ƒê·ªí ---
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json', 
            center: [105.4, 19.3], 
            zoom: 7.2, pitch: 0, antialias: true
        });

        // --- 2. GLOBAL VARIABLES ---
        let mapData = { features: [] };
        let isDrawing = false;
        let currentDrawType = 'none';
        let currentPoints = [];
        let tempId = 'temp-layer';
        
        let selectedIcon = 'fire';
        let selectedArrowHead = null;
        
        // Selection variables for Bending
        let selectedLineId = null; 
        let selectedPolyId = null;
        let isBending = false;

        let currentTimelineStep = 999;
        let arrowCounter = 0;

        // NEW VARIABLES FOR DELETE MODE
        let pendingDeleteId = null; // ID ƒë·ªëi t∆∞·ª£ng ƒëang ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ x√≥a
        let suppressDeleteWarning = false; // Tr·∫°ng th√°i "kh√¥ng nh·∫Øc l·∫°i"

        // --- 3. KH·ªûI T·∫†O ---
        map.on('load', () => {
            map.addSource('vietnam-border', { type: 'geojson', data: 'https://raw.githubusercontent.com/vietnam-geospatial/vietnam-administrative-boundaries/master/vietnam_boundary.geojson' });
            map.addLayer({ id: 'vn-border-halo', type: 'line', source: 'vietnam-border', paint: { 'line-color': '#f1c40f', 'line-width': 6, 'line-opacity': 0.4 } });
            map.addLayer({ id: 'vn-border-line', type: 'line', source: 'vietnam-border', paint: { 'line-color': '#8b4513', 'line-width': 2 } });
            createStaticLegend();
        });

        function createStaticLegend() {
            const container = document.getElementById('static-legend-container');
            const items = [
                { icon: '<i class="fas fa-fire" style="color:#e67e22"></i>', text: 'N∆°i L√™ L·ª£i d·ª±ng c·ªù', type: 'marker', color: '#e67e22', iconName: 'fire' },
                { icon: '<i class="fas fa-long-arrow-alt-right" style="color:#c0392b; transform: rotate(-45deg);"></i>', text: 'H∆∞·ªõng ti·∫øn nghƒ©a qu√¢n', type: 'arrow', color: '#c0392b', dashed: false },
                { icon: '<i class="fas fa-long-arrow-alt-right" style="color:#c0392b; border-bottom:2px dashed #c0392b;"></i>', text: 'Nghƒ©a qu√¢n r√∫t/b√≠ m·∫≠t', type: 'arrow', color: '#c0392b', dashed: true },
                { icon: '<i class="fas fa-star" style="color:#f1c40f"></i>', text: 'N∆°i ƒë√°nh b·∫°i qu√¢n Minh', type: 'marker', color: '#f1c40f', iconName: 'star' },
                { icon: '<i class="fas fa-chess-rook" style="color:#7f8c8d"></i>', text: 'Th√†nh qu√¢n Minh b·ªã v√¢y', type: 'marker', color: '#7f8c8d', iconName: 'chess-rook' },
                { icon: '<i class="fas fa-long-arrow-alt-right" style="color:#2980b9; border-bottom:2px dashed #2980b9;"></i>', text: 'Qu√¢n Minh r√∫t ch·∫°y', type: 'arrow', color: '#2980b9', dashed: true },
                { icon: '<div style="width:14px;height:14px;background:#eab676;opacity:0.8;border:1px solid #d35400"></div>', text: 'V√πng ho·∫°t ƒë·ªông 1418-1423', type: 'polygon', color: '#eab676', dashed: false },
                { icon: '<div style="width:14px;height:14px;background:#a2d9a2;opacity:0.8;border:1px solid #27ae60"></div>', text: 'V√πng gi·∫£i ph√≥ng 1424-1425', type: 'polygon', color: '#a2d9a2', dashed: false },
                { icon: '<div style="width:14px;height:14px;background:#c3e6cb;opacity:0.8;border:1px solid #2ecc71"></div>', text: 'V√πng gi·∫£i ph√≥ng 1426-1427', type: 'polygon', color: '#c3e6cb', dashed: false },
                { icon: '<div style="width:20px;height:0px;border-top:2px dashed #000;"></div>', text: 'Bi√™n gi·ªõi qu·ªëc gia', type: 'none', color: '#000' }
            ];

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'legend-row';
                div.innerHTML = `<div class="l-icon">${item.icon}</div><div class="l-text">${item.text}</div>`;
                if(item.type !== 'none') {
                    div.title = "Click ƒë·ªÉ ch·ªçn v·∫Ω lo·∫°i n√†y";
                    div.onclick = () => {
                        document.getElementById('draw-mode').value = item.type;
                        document.getElementById('draw-color').value = item.color;
                        if(item.type === 'arrow') document.getElementById('draw-dashed').checked = item.dashed;
                        if(item.type === 'marker') selectIcon(item.iconName);
                        updateUI();
                        if(!isDrawing) toggleDrawing();
                    };
                }
                container.appendChild(div);
            });
        }

        function toggleLegend() {
            const leg = document.getElementById('floating-legend');
            const icon = document.getElementById('legend-icon');
            leg.classList.toggle('minimized');
            icon.className = leg.classList.contains('minimized') ? "fas fa-chevron-up" : "fas fa-chevron-down";
        }

        let labelsVisible = true;
        function toggleMapLabels() {
            labelsVisible = !labelsVisible;
            const btn = document.getElementById('label-toggle-btn');
            btn.innerHTML = labelsVisible ? '<i class="fas fa-font"></i>' : '<i class="fas fa-slash"></i>';
            btn.style.color = labelsVisible ? 'white' : '#aaa';
            const layers = map.getStyle().layers;
            layers.forEach(layer => {
                if (layer.type === 'symbol' || layer.id.includes('label') || layer.id.includes('place') || layer.id.includes('poi')) {
                    map.setLayoutProperty(layer.id, 'visibility', labelsVisible ? 'visible' : 'none');
                }
            });
        }

        // --- 5. LOGIC V·∫º V√Ä X·ª¨ L√ù CLICK ---
        function toggleDrawing() {
            isDrawing = !isDrawing;
            const btn = document.getElementById('action-btn');
            currentDrawType = document.getElementById('draw-mode').value;
            
            // N·∫øu l√† ch·∫ø ƒë·ªô X√≥a
            if(currentDrawType === 'delete') {
                isDrawing = true; // Gi·ªØ true ƒë·ªÉ k√≠ch ho·∫°t c√°c s·ª± ki·ªán click
                btn.innerText = "THO√ÅT CH·∫æ ƒê·ªò X√ìA"; 
                btn.style.background = "#d35400"; 
                btn.style.color = "white";
                map.getCanvas().style.cursor = 'not-allowed'; // Con tr·ªè th·ªÉ hi·ªán t√≠nh nƒÉng x√≥a
                clearDeleteSelection(); // Reset l·ª±a ch·ªçn c≈©
            }
            else if(isDrawing) {
                btn.innerText = "D·ª™NG V·∫º (ESC)"; btn.style.background = "#c0392b"; btn.style.color = "white";
                map.getCanvas().style.cursor = 'crosshair';
            } else {
                stopDrawing();
            }
        }

        function stopDrawing() {
            isDrawing = false; currentPoints = [];
            const btn = document.getElementById('action-btn');
            btn.innerText = "B·∫Øt ƒë·∫ßu v·∫Ω"; btn.style.background = "#5d4037"; btn.style.color = "#f1c40f";
            map.getCanvas().style.cursor = '';
            if(map.getLayer(tempId)) map.removeLayer(tempId);
            if(map.getSource(tempId)) map.removeSource(tempId);
            clearDeleteSelection();
        }

        // --- H√ÄM X·ª¨ L√ù CH·ªåN ƒê·ªêI T∆Ø·ª¢NG ƒê·ªÇ X√ìA (ICON, TEXT) ---
        // H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ event listener c·ªßa marker
        function trySelectForDelete(id, element) {
             if (currentDrawType === 'delete') {
                clearDeleteSelection();
                pendingDeleteId = id;
                element.classList.add('selected-danger');
                
                // Show tooltip nh·∫Øc nh·ªü
                new maplibregl.Popup({closeButton:false, closeOnClick:true, offset: 25})
                    .setLngLat(mapData.features.find(f=>f.id===id).data) // L·∫•y v·ªã tr√≠ t·ª´ data
                    .setHTML('<div style="color:red; font-weight:bold;">ƒê√£ ch·ªçn! Nh·∫•n X ƒë·ªÉ x√≥a</div>')
                    .addTo(map);
                return true;
             }
             return false;
        }

        // X·ª≠ l√Ω click chung tr√™n b·∫£n ƒë·ªì
        map.on('click', (e) => {
            if (!isDrawing) {
                // ... (Logic b·∫ª cong c≈©)
                const point = e.point;
                const arrowFeatures = map.queryRenderedFeatures(point, { layers: mapData.features.filter(f=>f.type==='arrow').map(f=>f.id) });
                if (arrowFeatures.length > 0) {
                    selectedLineId = arrowFeatures[0].layer.id; selectedPolyId = null;
                    new maplibregl.Popup().setLngLat(e.lngLat).setHTML('<div class="bend-popup"><b>ƒê√£ ch·ªçn m≈©i t√™n</b><br>Gi·ªØ <b>Z</b> + Di chu·ªôt ƒë·ªÉ u·ªën cong.</div>').addTo(map);
                    return;
                }
                const polyLayers = mapData.features.filter(f=>f.type==='polygon').map(f=>f.id + '-fill');
                const polyFeatures = map.queryRenderedFeatures(point, { layers: polyLayers });
                if (polyFeatures.length > 0) {
                    selectedPolyId = polyFeatures[0].layer.id.replace('-fill', ''); selectedLineId = null;
                    new maplibregl.Popup().setLngLat(e.lngLat).setHTML('<div class="bend-popup"><b>ƒê√£ ch·ªçn v√πng</b><br>Gi·ªØ <b>Z</b> + Di chu·ªôt v√†o c·∫°nh ƒë·ªÉ k√©o d√£n.</div>').addTo(map);
                    return;
                }
                return;
            }

            // --- X·ª¨ L√ù CHO CH·∫æ ƒê·ªò X√ìA (M·ªöI) ---
            if (currentDrawType === 'delete') {
                const point = e.point;
                clearDeleteSelection();

                // 1. Ki·ªÉm tra M≈©i t√™n (Line)
                const arrowLayers = mapData.features.filter(f=>f.type==='arrow').map(f=>f.id);
                const arrowFeatures = map.queryRenderedFeatures(point, { layers: arrowLayers });
                
                if (arrowFeatures.length > 0) {
                    const id = arrowFeatures[0].layer.id;
                    pendingDeleteId = id;
                    // Highlight Line b·∫±ng c√°ch ƒë·ªïi m√†u t·∫°m th·ªùi (ho·∫∑c v·∫Ω l·∫°i line ƒë·ªè ƒë√® l√™n)
                    // ·ªû ƒë√¢y ta d√πng paint property ƒë·ªÉ ƒë·ªïi m√†u
                    map.setPaintProperty(id, 'line-color', '#ff0000'); 
                    map.setPaintProperty(id, 'line-width', 6);
                    new maplibregl.Popup({closeButton:false}).setLngLat(e.lngLat).setHTML('<div style="color:red; font-weight:bold;">ƒê√£ ch·ªçn! Nh·∫•n X ƒë·ªÉ x√≥a</div>').addTo(map);
                    return;
                }

                // 2. Ki·ªÉm tra V√πng (Polygon)
                const polyLayers = mapData.features.filter(f=>f.type==='polygon').map(f=>f.id + '-fill');
                const polyFeatures = map.queryRenderedFeatures(point, { layers: polyLayers });
                
                if (polyFeatures.length > 0) {
                    const id = polyFeatures[0].layer.id.replace('-fill', '');
                    pendingDeleteId = id;
                    map.setPaintProperty(id + '-fill', 'fill-color', '#ff0000');
                    map.setPaintProperty(id + '-fill', 'fill-opacity', 0.7);
                    new maplibregl.Popup({closeButton:false}).setLngLat(e.lngLat).setHTML('<div style="color:red; font-weight:bold;">ƒê√£ ch·ªçn! Nh·∫•n X ƒë·ªÉ x√≥a</div>').addTo(map);
                    return;
                }
                return;
            }

            // ... (Logic v·∫Ω c≈©)
            const color = document.getElementById('draw-color').value;
            const size = document.getElementById('draw-size').value;
            const label = document.getElementById('draw-label').value;

            if (currentDrawType === 'marker') {
                const id = 'marker-' + Date.now();
                addIconMarker(e.lngLat, selectedIcon, color, size, label, id);
                saveFeature(id, 'marker', {lng: e.lngLat.lng, lat: e.lngLat.lat, icon: selectedIcon}, {color, size}, label, 0);
            }
            else if (currentDrawType === 'text') {
                const text = document.getElementById('text-content').value || "ƒê·ªãa danh";
                const font = document.getElementById('text-font').value;
                const isBold = document.getElementById('text-bold').checked;
                const isItalic = document.getElementById('text-italic').checked;
                const id = 'text-' + Date.now();
                addTextMarker(e.lngLat, text, color, size, font, isBold, isItalic, id);
                saveFeature(id, 'text', {lng: e.lngLat.lng, lat: e.lngLat.lat, text}, {color, size, font, isBold, isItalic}, label, 0);
            }
            else if (currentDrawType === 'arrow' || currentDrawType === 'polygon') {
                currentPoints.push([e.lngLat.lng, e.lngLat.lat]);
                updateTempLayer(currentDrawType === 'arrow' ? 'line' : 'fill');
            }
        });

        // --- HELPERS CHO DELETE MODE ---
        function clearDeleteSelection() {
            if(pendingDeleteId) {
                // Kh√¥i ph·ª•c tr·∫°ng th√°i c≈© cho ƒë·ªëi t∆∞·ª£ng
                const feat = mapData.features.find(f => f.id === pendingDeleteId);
                if(feat) {
                    // Marker/Text: Remove class
                    const el = document.getElementById(pendingDeleteId);
                    if(el) el.classList.remove('selected-danger');

                    // Arrow: Reset paint
                    if(feat.type === 'arrow') {
                        if(map.getLayer(feat.id)) {
                            map.setPaintProperty(feat.id, 'line-color', feat.style.color);
                            map.setPaintProperty(feat.id, 'line-width', parseInt(feat.style.size));
                        }
                    }
                    // Polygon: Reset paint
                    if(feat.type === 'polygon') {
                         if(map.getLayer(feat.id+'-fill')) {
                            map.setPaintProperty(feat.id+'-fill', 'fill-color', feat.style.color);
                            map.setPaintProperty(feat.id+'-fill', 'fill-opacity', feat.style.opacity);
                         }
                    }
                }
                pendingDeleteId = null;
                // X√≥a popup nh·∫Øc nh·ªü
                const popup = document.querySelector('.maplibregl-popup');
                if(popup) popup.remove();
            }
        }

        // --- 6. X·ª¨ L√ù S·ª∞ KI·ªÜN PH√çM & X√ìA ---
        const modal = document.getElementById('delete-confirm-modal');
        
        document.addEventListener('keydown', (e) => {
            // Logic ph√≠m X cho x√≥a
            if ((e.key === 'x' || e.key === 'X') && currentDrawType === 'delete' && pendingDeleteId) {
                if (suppressDeleteWarning) {
                    executeDelete();
                } else {
                    modal.style.display = 'flex';
                }
            }

            if (e.key === 'z' || e.key === 'Z') isBending = true;
            if (e.key === 'Escape') stopDrawing();
            if (e.key.toLowerCase() === 't') changeTimeline(1);
            if (e.key.toLowerCase() === 'y') changeTimeline(-1);
            if (selectedArrowHead) {
                if (e.key.toLowerCase() === 'a') { selectedArrowHead.bearing -= 5; updateArrowHeadRotation(); }
                if (e.key.toLowerCase() === 'd') { selectedArrowHead.bearing += 5; updateArrowHeadRotation(); }
            }
        });
        
        // Modal Event Listeners
        document.getElementById('btn-confirm-delete').addEventListener('click', function() {
            if (document.getElementById('chk-no-remind').checked) {
                suppressDeleteWarning = true;
            }
            executeDelete();
            modal.style.display = 'none';
        });

        document.getElementById('btn-cancel-delete').addEventListener('click', function() {
            modal.style.display = 'none';
        });

        function executeDelete() {
            if (pendingDeleteId) {
                deleteFeature(pendingDeleteId);
                pendingDeleteId = null;
            }
        }

        // ... (C√°c ph·∫ßn code c≈©) ...
        document.addEventListener('keyup', (e) => { if (e.key === 'z' || e.key === 'Z') isBending = false; });
        function updateArrowHeadRotation() {
            if(!selectedArrowHead) return;
            selectedArrowHead.element.querySelector('i').style.transform = `rotate(${selectedArrowHead.bearing}deg)`;
        }

        map.on('dblclick', (e) => {
            if(!isDrawing || currentDrawType === 'delete') return; // Kh√¥ng v·∫Ω khi ·ªü ch·∫ø ƒë·ªô x√≥a
            e.preventDefault();
            const color = document.getElementById('draw-color').value;
            const size = document.getElementById('draw-size').value;
            let label = document.getElementById('draw-label').value;

            if (currentDrawType === 'arrow' && currentPoints.length > 1) {
                arrowCounter++;
                if(!label) label = `M≈©i ti·∫øn c√¥ng ${arrowCounter}`;
                const dashed = document.getElementById('draw-dashed').checked;
                const id = 'arrow-' + Date.now();
                addArrowToMap(currentPoints, color, size, dashed, id, arrowCounter);
                saveFeature(id, 'arrow', currentPoints, {color, size, dashed}, label, arrowCounter);
                selectedLineId = id; 
                stopDrawing();
            }
            else if (currentDrawType === 'polygon' && currentPoints.length > 2) {
                const isSmooth = document.getElementById('poly-smooth').checked;
                const isDashed = document.getElementById('poly-dashed').checked;
                const id = 'poly-' + Date.now();
                currentPoints.push(currentPoints[0]);
                let finalCoords = currentPoints;
                if (isSmooth) {
                    try {
                        const line = turf.lineString(currentPoints);
                        const curved = turf.bezierSpline(line, { resolution: 10000, sharpness: 0.5 });
                        finalCoords = curved.geometry.coordinates;
                    } catch (err) { }
                }
                addPolygonToMap(finalCoords, color, 0.5, id, isDashed);
                saveFeature(id, 'polygon', finalCoords, {color, opacity: 0.5, isDashed, isSmooth}, label, 0);
                selectedPolyId = id;
                stopDrawing();
            }
        });

        function updateTempLayer(type) {
            const data = { type: 'Feature', geometry: { type: type === 'line' ? 'LineString' : 'Polygon', coordinates: type === 'line' ? currentPoints : [currentPoints] } };
            if (map.getSource(tempId)) { map.getSource(tempId).setData(data); }
            else {
                map.addSource(tempId, { type: 'geojson', data: data });
                const dashed = (type === 'line' && document.getElementById('draw-dashed').checked) || (type === 'fill' && document.getElementById('poly-dashed').checked);
                const paint = type === 'line' 
                    ? { 'line-color': '#c0392b', 'line-width': 3, 'line-dasharray': dashed ? [2, 2] : [1, 0] }
                    : { 'fill-color': '#333', 'fill-opacity': 0.3 };
                map.addLayer({ id: tempId, type: type, source: tempId, paint: paint });
            }
        }

        map.on('mousemove', (e) => {
            if (isBending && selectedLineId) {
                const featureObj = mapData.features.find(f => f.id === selectedLineId);
                if (featureObj && featureObj.type === 'arrow') {
                    const originalCoords = featureObj.data; 
                    const start = originalCoords[0];
                    const end = originalCoords[originalCoords.length - 1];
                    const mouse = [e.lngLat.lng, e.lngLat.lat];
                    const line = turf.lineString([start, mouse, end]);
                    const curved = turf.bezierSpline(line, { resolution: 10000, sharpness: 0.6 });
                    map.getSource(selectedLineId).setData(curved);
                }
            }
            if (isBending && selectedPolyId) {
                const featureObj = mapData.features.find(f => f.id === selectedPolyId);
                if (featureObj && featureObj.type === 'polygon') {
                    const mousePoint = turf.point([e.lngLat.lng, e.lngLat.lat]);
                    const polyCoords = featureObj.data; 
                    let minDist = Infinity;
                    let insertIndex = -1;
                    for(let i=0; i<polyCoords.length-1; i++) {
                        const segment = turf.lineString([polyCoords[i], polyCoords[i+1]]);
                        const dist = turf.pointToLineDistance(mousePoint, segment);
                        if(dist < minDist) { minDist = dist; insertIndex = i + 1; }
                    }
                    if(insertIndex !== -1) {
                        const newCoords = [...polyCoords.slice(0, insertIndex), [e.lngLat.lng, e.lngLat.lat], ...polyCoords.slice(insertIndex)];
                        const tempLine = turf.lineString(newCoords);
                        const curved = turf.bezierSpline(tempLine, { resolution: 5000, sharpness: 0.5 });
                        const polyData = { type: 'Feature', geometry: { type: 'Polygon', coordinates: [curved.geometry.coordinates] } };
                        map.getSource(selectedPolyId).setData(polyData);
                    }
                }
            }
        });

        // --- 7. TIMELINE & DATA ---
        function saveFeature(id, type, data, style, label, order) {
            mapData.features.push({ id, type, data, style, label, order });
            renderTimelineTable();
        }

        function renderTimelineTable() {
            const tbody = document.getElementById('timeline-list');
            tbody.innerHTML = '';
            const arrows = mapData.features.filter(f => f.type === 'arrow').sort((a,b) => a.order - b.order);
            
            arrows.forEach(feat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td align="center">
                        <input type="number" class="order-input" value="${feat.order}" onchange="updateFeatureOrder('${feat.id}', this.value)">
                    </td>
                    <td style="color:${feat.style.color}">${feat.label}</td>
                    <td align="center"><i class="fas fa-trash" style="cursor:pointer; color:#e74c3c;" onclick="confirmDeleteFromTable('${feat.id}')"></i></td>
                `;
                tbody.appendChild(tr);
            });
            updateVisibility();
        }

        window.updateFeatureOrder = function(id, newOrderVal) {
            const newOrder = parseInt(newOrderVal);
            if(isNaN(newOrder)) return;
            const feature = mapData.features.find(f => f.id === id);
            if(feature) {
                feature.order = newOrder;
                if(newOrder > arrowCounter) arrowCounter = newOrder;
                renderTimelineTable();
            }
        }
        
        function confirmDeleteFromTable(id) {
             pendingDeleteId = id;
             if (suppressDeleteWarning) executeDelete();
             else modal.style.display = 'flex';
        }

        function deleteFeature(id) {
            // Kh√¥ng d√πng confirm m·∫∑c ƒë·ªãnh n·ªØa, logic ƒë√£ chuy·ªÉn ra ngo√†i
            if(map.getLayer(id)) map.removeLayer(id);
            if(map.getLayer(id+'-fill')) map.removeLayer(id+'-fill'); 
            if(map.getLayer(id+'-outline')) map.removeLayer(id+'-outline');
            if(map.getSource(id)) map.removeSource(id);
            const el = document.getElementById(id); if(el) el.remove();
            const headEl = document.getElementById(id+'-head'); if(headEl) headEl.remove();
            mapData.features = mapData.features.filter(f => f.id !== id);
            renderTimelineTable();
            
            // X√≥a popup n·∫øu c√≤n s√≥t
            const popup = document.querySelector('.maplibregl-popup');
            if(popup) popup.remove();
        }

        function changeTimeline(val) {
            if (currentTimelineStep === 999 && val === 1) currentTimelineStep = 0;
            currentTimelineStep += val;
            if (currentTimelineStep < 0) currentTimelineStep = 0;
            if (currentTimelineStep > arrowCounter + 5) currentTimelineStep = 999;
            document.getElementById('current-step-display').innerText = currentTimelineStep === 999 ? "Hi·ªán t·∫•t c·∫£" : `B∆∞·ªõc: ${currentTimelineStep}`;
            updateVisibility();
        }

        function showAllTimeline() {
            currentTimelineStep = 999;
            document.getElementById('current-step-display').innerText = "Hi·ªán t·∫•t c·∫£";
            updateVisibility();
        }

        function updateVisibility() {
            mapData.features.forEach(feat => {
                if (feat.type !== 'arrow') return; 
                const isVisible = (currentTimelineStep === 999) || (feat.order <= currentTimelineStep);
                if (map.getLayer(feat.id)) map.setLayoutProperty(feat.id, 'visibility', isVisible ? 'visible' : 'none');
                const head = document.getElementById(feat.id + '-head');
                if (head) head.style.display = isVisible ? 'block' : 'none';
            });
        }

        // --- 8. RENDER HELPERS ---
        function addArrowToMap(coords, color, size, dashed, id, order) {
            map.addSource(id, { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: coords } } });
            map.addLayer({
                id: id, type: 'line', source: id,
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': color, 'line-width': parseInt(size), 'line-dasharray': dashed ? [2, 2] : [1, 0] }
            });
            
            const last = coords[coords.length - 1];
            const prev = coords[coords.length - 2];
            let bearing = turf.bearing(turf.point(prev), turf.point(last));
            const headSize = parseInt(size) * 6;
            
            const el = document.createElement('div');
            el.className = `map-feature feature-arrow arrow-order-${order}`;
            el.id = id + '-head';
            el.innerHTML = `<i class="fas fa-long-arrow-alt-up" style="color: ${color}; font-size: ${headSize}px; display:block; text-shadow:0 0 2px white;"></i>`;
            el.style.cursor = 'pointer';
            el.querySelector('i').style.transform = `rotate(${bearing}deg)`;

            const marker = new maplibregl.Marker({ element: el }).setLngLat(last).addTo(map);

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                // Check Delete Mode
                if(trySelectForDelete(id, el)) return;

                if(selectedArrowHead) selectedArrowHead.element.style.outline = 'none';
                selectedArrowHead = { marker: marker, element: el, bearing: bearing };
                el.style.borderRadius = "50%"; el.style.outline = "2px dashed #f1c40f";
            });
        }

        function addPolygonToMap(coords, color, opacity, id, isDashed) {
            map.addSource(id, { type: 'geojson', data: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [coords] } } });
            map.addLayer({ id: id + '-fill', type: 'fill', source: id, paint: { 'fill-color': color, 'fill-opacity': opacity } });
            map.addLayer({ id: id + '-outline', type: 'line', source: id, paint: { 'line-color': color, 'line-width': 2, 'line-dasharray': isDashed ? [2, 2] : [1, 0] } });
        }

        function addIconMarker(lngLat, icon, color, size, label, id) {
            const el = document.createElement('div'); el.className = `map-feature`; el.id = id;
            const px = parseInt(size) * 8; 
            el.innerHTML = `<i class="fas fa-${icon}" style="color:${color}; font-size:${px}px; text-shadow: 1px 1px 1px black;"></i>`;
            // Add Click listener for Delete
            el.addEventListener('click', (e) => {
                 e.stopPropagation();
                 trySelectForDelete(id, el);
            });
            new maplibregl.Marker({ element: el }).setLngLat(lngLat).addTo(map);
        }

        function addTextMarker(lngLat, text, color, size, font, bold, italic, id) {
            const el = document.createElement('div'); el.className = `custom-text-marker`; el.id = id;
            el.style.color = color; el.style.fontSize = (parseInt(size) * 5) + 'px';
            el.style.fontFamily = font; el.style.fontWeight = bold ? 'bold' : 'normal'; el.style.fontStyle = italic ? 'italic' : 'normal';
            el.innerText = text;
            el.style.cursor = 'pointer';
            // Add Click listener for Delete
            el.addEventListener('click', (e) => {
                 e.stopPropagation();
                 trySelectForDelete(id, el);
            });
            new maplibregl.Marker({ element: el }).setLngLat(lngLat).addTo(map);
        }

        // Utils
        function selectIcon(name) { selectedIcon = name; document.querySelectorAll('.icon-option').forEach(el=>el.classList.remove('selected')); event.currentTarget.classList.add('selected'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function updateUI() {
            const mode = document.getElementById('draw-mode').value;
            // N·∫øu l√† delete mode th√¨ ·∫©n h·∫øt option
            if (mode === 'delete') {
                document.getElementById('options-panel').style.display = 'none';
                return;
            }
            document.getElementById('options-panel').style.display = mode === 'none' ? 'none' : 'block';
            document.getElementById('icon-options').style.display = mode === 'marker' ? 'block' : 'none';
            document.getElementById('text-options').style.display = mode === 'text' ? 'block' : 'none';
            document.getElementById('arrow-specific-options').style.display = mode === 'arrow' ? 'block' : 'none';
            document.getElementById('polygon-specific-options').style.display = mode === 'polygon' ? 'block' : 'none';
        }
        function exportJSON() {
            const blob = new Blob([JSON.stringify(mapData)], {type: "application/json"});
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = "tactical_map_v6.json"; link.click();
        }
        function importJSON(input) { alert("Ch·ª©c nƒÉng Import ƒëang b·∫£o tr√¨."); }

    </script>
</body>
</html>
